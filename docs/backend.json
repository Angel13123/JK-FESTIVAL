{
  "entities": {
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents an order placed for JK Festival tickets.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order entity."
        },
        "customerName": {
          "type": "string",
          "description": "Name of the customer who placed the order."
        },
        "customerEmail": {
          "type": "string",
          "description": "Email of the customer who placed the order.",
          "format": "email"
        },
        "totalAmount": {
          "type": "number",
          "description": "Total amount of the order."
        },
        "ticketItems": {
          "type": "array",
          "description": "Array of ticket items in the order.",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the order was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "customerName",
        "customerEmail",
        "totalAmount",
        "ticketItems",
        "createdAt"
      ]
    },
    "Ticket": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Ticket",
      "type": "object",
      "description": "Represents a ticket for the JK Festival.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ticket entity."
        },
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:N Ticket)"
        },
        "customerName": {
          "type": "string",
          "description": "Name of the customer who owns the ticket."
        },
        "customerEmail": {
          "type": "string",
          "description": "Email of the customer who owns the ticket.",
          "format": "email"
        },
        "ticketType": {
          "type": "string",
          "description": "Type of the ticket (e.g., General, VIP)."
        },
        "status": {
          "type": "string",
          "description": "Status of the ticket (valid or used).",
          "format": "string"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the ticket was created.",
          "format": "date-time"
        },
        "code": {
          "type": "string",
          "description": "Unique code for the ticket."
        }
      },
      "required": [
        "id",
        "orderId",
        "customerName",
        "customerEmail",
        "ticketType",
        "status",
        "createdAt",
        "code"
      ]
    },
    "AppUser": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AppUser",
      "type": "object",
      "description": "Represents a user account for the mobile app.",
      "properties": {
        "email": {
          "type": "string",
          "description": "The user's email, used as a unique identifier.",
          "format": "email"
        },
        "username": {
          "type": "string",
          "description": "The user's chosen display name."
        },
        "pin": {
          "type": "string",
          "description": "A 4-digit PIN for authentication.",
          "pattern": "^[0-9]{4}$"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "email",
        "username",
        "pin",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores order information. Uses orderId as document ID.",
          "params": [
            {
              "name": "orderId",
              "description": "The unique identifier for the order document."
            }
          ]
        }
      },
      {
        "path": "tickets/{ticketId}",
        "definition": {
          "entityName": "Ticket",
          "schema": {
            "$ref": "#/backend/entities/Ticket"
          },
          "description": "Stores ticket information. Includes denormalized 'customerName' and 'customerEmail' for authorization independence. Uses ticketId as document ID.",
          "params": [
            {
              "name": "ticketId",
              "description": "The unique identifier for the ticket document."
            }
          ]
        }
      },
      {
        "path": "app_users/{email}",
        "definition": {
          "entityName": "AppUser",
          "schema": {
            "$ref": "#/backend/entities/AppUser"
          },
          "description": "Stores mobile app user accounts. The user's email is used as the document ID.",
          "params": [
            {
              "name": "email",
              "description": "The user's email address."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore database structure is designed to manage orders and tickets for the JK Festival. It uses two collections: `orders` and `tickets`. The `tickets` collection includes the `orderId` to establish a relationship with the `orders` collection. To maintain Authorization Independence, particularly for listing tickets related to a specific order, the `customerName` and `customerEmail` are duplicated in the `tickets` collection, avoiding the need for security rules to fetch the parent order document. The `id` field is used as the document id.\n\nA new `app_users` collection has been added to support a separate authentication system for the PWA/mobile app experience. This collection stores user profiles with an email, username, and a 4-digit PIN. The user's email serves as the unique document ID, simplifying lookups. This structure separates website order data from app user accounts, while still allowing tickets to be linked to users via their email address.\n\nThis structure supports the required QAPs:\n\n1.  **Secure `list` operations for tickets by order:** By including `orderId` and the relevant customer information on each ticket, security rules can efficiently validate access to tickets belonging to a specific order without requiring `get()` operations on the parent `order` document. This avoids hierarchical authorization and ensures atomic operations.\n2. **Email-based Ticket Sync**: The app can query the `tickets` collection using the logged-in user's email to find their purchased tickets, effectively linking web purchases to app accounts.\n3. **Data integrity:** Timestamps (`createdAt`) are included in `orders`, `tickets`, and `app_users` to track creation times. The explicit `status` field in the `tickets` collection (`valid` or `used`) maintains clear state management for tickets.\n4. **Clarity of Intent**: The document structures are named semantically."
  }
}
